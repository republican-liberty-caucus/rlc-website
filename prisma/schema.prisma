// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ===========================================
// Enums
// ===========================================

enum MembershipTier {
  student_military
  individual
  premium
  sustaining
  patron
  benefactor
  roundtable
}

enum MembershipStatus {
  new_member  // "new" is reserved in SQL, so we use new_member in Prisma but map to "new" in app logic
  current
  grace
  expired
  pending
  cancelled
  deceased
  expiring
}

enum ContributionType {
  membership
  donation
  event_registration
  merchandise
}

enum PaymentStatus {
  pending
  completed
  failed
  refunded
  cancelled
}

enum ChapterLevel {
  national
  multi_state_region
  state
  intra_state_region
  county
}

enum ChapterStatus {
  active
  inactive
  forming
}

enum HouseholdRole {
  primary
  spouse
  child
}

enum UserRole {
  member
  chapter_officer
  chapter_admin
  state_chair
  regional_coordinator
  national_board
  super_admin
}

// Phase 4 enums (backfill — tables already exist)

enum SurveyStatus {
  draft
  active
  closed
}

enum CandidateResponseStatus {
  pending
  in_progress
  submitted
  endorsed
  not_endorsed
}

enum QuestionType {
  scale
  yes_no
  text
  multiple_choice
}

// Phase 5 enums

enum Jurisdiction {
  federal
  state
}

enum ScorecardSessionStatus {
  draft
  active
  published
  archived
}

enum LibertyPosition {
  yea
  nay
}

enum BillTrackingStatus {
  tracking
  voted
  no_vote
}

enum VoteChoice {
  yea
  nay
  not_voting
  absent
}

enum LegislativeChamber {
  us_house
  us_senate
  state_house
  state_senate
}

enum CampaignStatus {
  draft
  active
  completed
  cancelled
}

// Dues Sharing enums

enum DisbursementModel {
  national_managed
  state_managed
}

enum StripeConnectStatus {
  not_started
  onboarding
  active
  disabled
}

enum SplitLedgerStatus {
  pending
  transferred
  reversed
  failed
}

enum SplitSourceType {
  membership
  donation
  event_registration
}

// ===========================================
// Core Tables
// ===========================================

/// Organizational hierarchy (self-referential)
model Chapter {
  id               String        @id @default(uuid())
  name             String
  slug             String        @unique
  chapterLevel     ChapterLevel  @map("chapter_level")
  parentChapterId  String?       @map("parent_chapter_id")
  parent           Chapter?      @relation("ChapterHierarchy", fields: [parentChapterId], references: [id])
  children         Chapter[]     @relation("ChapterHierarchy")
  stateCode        String?       @map("state_code") @db.Char(2)
  regionName       String?       @map("region_name")
  status           ChapterStatus @default(active)
  websiteUrl       String?       @map("website_url")
  contactEmail     String?       @map("contact_email")
  leadership       Json          @default("{}")
  metadata         Json          @default("{}")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  // Relations
  members            Member[]
  memberRoles        MemberRole[]
  contributions      Contribution[]
  events             Event[]
  posts              Post[]
  surveys            Survey[]
  scorecardSessions  ScorecardSession[]
  actionCampaigns    ActionCampaign[]

  // Dues sharing relations
  stripeAccount        ChapterStripeAccount?
  splitConfig          ChapterSplitConfig?
  splitRulesAsRecipient ChapterSplitRule[]   @relation("SplitRuleRecipient")
  splitLedgerEntries   SplitLedgerEntry[]    @relation("LedgerRecipient")

  @@map("rlc_chapters")
}

/// Members (synced with Clerk users)
model Member {
  id                   String           @id @default(uuid())
  clerkUserId          String?          @unique @map("clerk_user_id")
  email                String           @unique
  firstName            String           @map("first_name")
  lastName             String           @map("last_name")
  phone                String?
  addressLine1         String?          @map("address_line1")
  addressLine2         String?          @map("address_line2")
  city                 String?
  state                String?
  postalCode           String?          @map("postal_code")
  country              String           @default("US")

  // Membership
  membershipTier       MembershipTier   @default(individual) @map("membership_tier")
  membershipStatus     MembershipStatus @default(pending) @map("membership_status")
  membershipStartDate  DateTime?        @map("membership_start_date")
  membershipExpiryDate DateTime?        @map("membership_expiry_date")
  membershipJoinDate   DateTime?        @map("membership_join_date")

  // Chapter affiliation
  primaryChapterId     String?          @map("primary_chapter_id")
  primaryChapter       Chapter?         @relation(fields: [primaryChapterId], references: [id])

  // External IDs
  highlevelContactId   String?          @unique @map("highlevel_contact_id")
  civicrmContactId     Int?             @unique @map("civicrm_contact_id")
  stripeCustomerId     String?          @unique @map("stripe_customer_id")

  // Preferences
  emailOptIn           Boolean          @default(true) @map("email_opt_in")
  smsOptIn             Boolean          @default(false) @map("sms_opt_in")
  doNotPhone           Boolean          @default(false) @map("do_not_phone")

  // Household / family members
  householdId          String?          @map("household_id")
  householdRole        HouseholdRole?   @map("household_role")
  primaryMemberId      String?          @map("primary_member_id")
  primaryMember        Member?          @relation("HouseholdMembers", fields: [primaryMemberId], references: [id])
  householdMembers     Member[]         @relation("HouseholdMembers")

  metadata             Json             @default("{}")
  createdAt            DateTime         @default(now()) @map("created_at")
  updatedAt            DateTime         @updatedAt @map("updated_at")

  // Relations
  roles                   MemberRole[]     @relation("MemberRoles")
  grantedRoles            MemberRole[]     @relation("GrantedRoles")
  contributions           Contribution[]
  organizedEvents         Event[]
  eventRegistrations      EventRegistration[]
  posts                   Post[]
  surveysCreated          Survey[]           @relation("SurveyCreator")
  scorecardSessionsCreated ScorecardSession[] @relation("ScorecardCreator")
  campaignsCreated        ActionCampaign[]   @relation("CampaignCreator")
  campaignParticipations  CampaignParticipation[]

  // Dues sharing relations
  splitConfigsUpdated    ChapterSplitConfig[] @relation("SplitConfigUpdater")

  @@map("rlc_members")
}

/// Member roles (multi-role support)
model MemberRole {
  id          String    @id @default(uuid())
  memberId    String    @map("member_id")
  member      Member    @relation("MemberRoles", fields: [memberId], references: [id], onDelete: Cascade)
  role        UserRole
  chapterId   String?   @map("chapter_id")
  chapter     Chapter?  @relation(fields: [chapterId], references: [id])
  grantedById String?   @map("granted_by")
  grantedBy   Member?   @relation("GrantedRoles", fields: [grantedById], references: [id])
  grantedAt   DateTime  @default(now()) @map("granted_at")
  expiresAt   DateTime? @map("expires_at")

  @@unique([memberId, role, chapterId])
  @@map("rlc_member_roles")
}

/// Contributions/Donations
model Contribution {
  id                    String           @id @default(uuid())
  memberId              String?          @map("member_id")
  member                Member?          @relation(fields: [memberId], references: [id])
  contributionType      ContributionType @map("contribution_type")
  amount                Decimal          @db.Decimal(10, 2)
  currency              String           @default("USD")

  // Payment details
  stripePaymentIntentId String?          @map("stripe_payment_intent_id")
  stripeSubscriptionId  String?          @map("stripe_subscription_id")
  paymentStatus         PaymentStatus    @default(pending) @map("payment_status")
  paymentMethod         String?          @map("payment_method")

  // Attribution
  chapterId             String?          @map("chapter_id")
  chapter               Chapter?         @relation(fields: [chapterId], references: [id])
  campaignId            String?          @map("campaign_id")

  // For recurring
  isRecurring           Boolean          @default(false) @map("is_recurring")
  recurringInterval     String?          @map("recurring_interval")

  // CiviCRM migration reference
  civicrmContributionId Int?             @unique @map("civicrm_contribution_id")
  transactionId         String?          @map("transaction_id")
  source                String?

  metadata              Json             @default("{}")
  createdAt             DateTime         @default(now()) @map("created_at")

  // Relations
  eventRegistrations    EventRegistration[]
  splitLedgerEntries    SplitLedgerEntry[]

  @@map("rlc_contributions")
}

/// Events
model Event {
  id                   String    @id @default(uuid())
  title                String
  slug                 String    @unique
  description          String?   @db.Text
  eventType            String?   @map("event_type")

  // Timing
  startDate            DateTime  @map("start_date")
  endDate              DateTime? @map("end_date")
  timezone             String    @default("America/New_York")

  // Location
  isVirtual            Boolean   @default(false) @map("is_virtual")
  locationName         String?   @map("location_name")
  address              String?
  city                 String?
  state                String?
  postalCode           String?   @map("postal_code")
  virtualUrl           String?   @map("virtual_url")

  // Registration
  registrationRequired Boolean   @default(true) @map("registration_required")
  maxAttendees         Int?      @map("max_attendees")
  registrationFee      Decimal?  @map("registration_fee") @db.Decimal(10, 2)
  registrationDeadline DateTime? @map("registration_deadline")

  // Ownership
  chapterId            String?   @map("chapter_id")
  chapter              Chapter?  @relation(fields: [chapterId], references: [id])
  organizerId          String?   @map("organizer_id")
  organizer            Member?   @relation(fields: [organizerId], references: [id])

  status               String    @default("draft")
  metadata             Json      @default("{}")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  // Relations
  registrations        EventRegistration[]

  @@map("rlc_events")
}

/// Event Registrations
model EventRegistration {
  id                 String        @id @default(uuid())
  eventId            String        @map("event_id")
  event              Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  memberId           String?       @map("member_id")
  member             Member?       @relation(fields: [memberId], references: [id])

  // For non-member registrations
  guestEmail         String?       @map("guest_email")
  guestName          String?       @map("guest_name")

  registrationStatus String        @default("registered") @map("registration_status")
  checkedInAt        DateTime?     @map("checked_in_at")

  // Payment
  contributionId     String?       @map("contribution_id")
  contribution       Contribution? @relation(fields: [contributionId], references: [id])

  metadata           Json          @default("{}")
  createdAt          DateTime      @default(now()) @map("created_at")

  @@map("rlc_event_registrations")
}

/// Content/Blog Posts
model Post {
  id               String    @id @default(uuid())
  title            String
  slug             String    @unique
  content          String?   @db.Text
  excerpt          String?   @db.Text
  featuredImageUrl String?   @map("featured_image_url")

  authorId         String?   @map("author_id")
  author           Member?   @relation(fields: [authorId], references: [id])
  chapterId        String?   @map("chapter_id")
  chapter          Chapter?  @relation(fields: [chapterId], references: [id])

  status           String    @default("draft")
  publishedAt      DateTime? @map("published_at")

  categories       String[]
  tags             String[]

  seoTitle         String?   @map("seo_title")
  seoDescription   String?   @map("seo_description")

  metadata         Json      @default("{}")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@map("rlc_posts")
}

/// HighLevel Sync Log
model HighLevelSyncLog {
  id              String   @id @default(uuid())
  entityType      String   @map("entity_type")
  entityId        String   @map("entity_id")
  highlevelId     String?  @map("highlevel_id")
  action          String
  status          String   @default("pending")
  errorMessage    String?  @map("error_message") @db.Text
  requestPayload  Json?    @map("request_payload")
  responsePayload Json?    @map("response_payload")
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("rlc_highlevel_sync_log")
}

/// CiviCRM Migration Tracking
model CiviCRMMigrationLog {
  id           String    @id @default(uuid())
  entityType   String    @map("entity_type")
  civicrmId    Int       @map("civicrm_id")
  supabaseId   String?   @map("supabase_id")
  status       String    @default("pending")
  errorMessage String?   @map("error_message") @db.Text
  migratedAt   DateTime? @map("migrated_at")

  @@unique([entityType, civicrmId])
  @@map("rlc_civicrm_migration_log")
}

// ===========================================
// Phase 4: Candidate Surveys (backfill — tables already exist in DB)
// ===========================================

/// Candidate Endorsement Surveys
model Survey {
  id            String       @id @default(uuid())
  title         String
  slug          String       @unique
  description   String?      @db.Text
  status        SurveyStatus @default(draft)
  electionType  String?      @map("election_type")
  electionDate  String?      @map("election_date")
  state         String?
  chapterId     String?      @map("chapter_id")
  chapter       Chapter?     @relation(fields: [chapterId], references: [id])
  createdBy     String?      @map("created_by")
  creator       Member?      @relation("SurveyCreator", fields: [createdBy], references: [id])
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  questions     SurveyQuestion[]
  candidates    CandidateResponse[]

  @@map("rlc_surveys")
}

/// Survey Questions
model SurveyQuestion {
  id           String       @id @default(uuid())
  surveyId     String       @map("survey_id")
  survey       Survey       @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  questionText String       @map("question_text")
  questionType QuestionType @map("question_type")
  options      String[]
  weight       Decimal      @default(1) @db.Decimal(3, 1)
  sortOrder    Int          @default(0) @map("sort_order")
  idealAnswer  String?      @map("ideal_answer")
  createdAt    DateTime     @default(now()) @map("created_at")

  answers      SurveyAnswer[]

  @@map("rlc_survey_questions")
}

/// Candidate survey responses
model CandidateResponse {
  id                String                  @id @default(uuid())
  surveyId          String                  @map("survey_id")
  survey            Survey                  @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  candidateName     String                  @map("candidate_name")
  candidateEmail    String?                 @map("candidate_email")
  candidateParty    String?                 @map("candidate_party")
  candidateOffice   String?                 @map("candidate_office")
  candidateDistrict String?                 @map("candidate_district")
  accessToken       String                  @map("access_token")
  status            CandidateResponseStatus @default(pending)
  totalScore        Decimal?                @map("total_score") @db.Decimal(5, 2)
  submittedAt       DateTime?               @map("submitted_at")
  createdAt         DateTime                @default(now()) @map("created_at")
  updatedAt         DateTime                @updatedAt @map("updated_at")

  answers           SurveyAnswer[]

  @@map("rlc_candidate_responses")
}

/// Individual survey answers
model SurveyAnswer {
  id                  String            @id @default(uuid())
  candidateResponseId String            @map("candidate_response_id")
  candidateResponse   CandidateResponse @relation(fields: [candidateResponseId], references: [id], onDelete: Cascade)
  questionId          String            @map("question_id")
  question            SurveyQuestion    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answer              String
  score               Decimal?          @db.Decimal(5, 2)

  @@map("rlc_survey_answers")
}

// ===========================================
// Phase 5: Liberty Scorecard & Action Center
// ===========================================

/// Legislators tracked for scorecard voting records
model Legislator {
  id                String              @id @default(uuid())
  legiscanPeopleId  Int?                @unique @map("legiscan_people_id")
  name              String
  party             String
  chamber           LegislativeChamber
  stateCode         String              @map("state_code")
  district          String?
  photoUrl          String?             @map("photo_url")
  currentScore      Decimal?            @map("current_score") @db.Decimal(5, 2)
  metadata          Json                @default("{}")
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")

  votes                    ScorecardVote[]
  campaignParticipations   CampaignParticipation[]

  @@map("rlc_legislators")
}

/// Scorecard sessions (e.g. "118th Congress" or "2025 Texas Session")
model ScorecardSession {
  id            String                  @id @default(uuid())
  name          String
  slug          String                  @unique
  jurisdiction  Jurisdiction            @default(federal)
  stateCode     String?                 @map("state_code")
  chapterId     String?                 @map("chapter_id")
  chapter       Chapter?                @relation(fields: [chapterId], references: [id])
  sessionYear   Int                     @map("session_year")
  status        ScorecardSessionStatus  @default(draft)
  createdBy     String?                 @map("created_by")
  creator       Member?                 @relation("ScorecardCreator", fields: [createdBy], references: [id])
  createdAt     DateTime                @default(now()) @map("created_at")
  updatedAt     DateTime                @updatedAt @map("updated_at")

  bills         ScorecardBill[]

  @@map("rlc_scorecard_sessions")
}

/// Bills tracked in a scorecard session
model ScorecardBill {
  id                   String              @id @default(uuid())
  sessionId            String              @map("session_id")
  session              ScorecardSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  legiscanBillId       Int?                @map("legiscan_bill_id")
  billNumber           String              @map("bill_number")
  title                String
  description          String?             @db.Text
  libertyPosition      LibertyPosition     @map("liberty_position")
  aiSuggestedPosition  LibertyPosition?    @map("ai_suggested_position")
  aiAnalysis           String?             @map("ai_analysis") @db.Text
  category             String              @default("other")
  weight               Decimal             @default(1.0) @db.Decimal(3, 1)
  voteDate             DateTime?           @map("vote_date") @db.Date
  billStatus           BillTrackingStatus  @default(tracking) @map("bill_status")
  legiscanRollCallId   Int?                @map("legiscan_roll_call_id")
  createdAt            DateTime            @default(now()) @map("created_at")
  updatedAt            DateTime            @updatedAt @map("updated_at")

  votes                ScorecardVote[]
  actionCampaigns      ActionCampaign[]

  @@map("rlc_scorecard_bills")
}

/// Individual legislator votes on scorecard bills
model ScorecardVote {
  id                 String        @id @default(uuid())
  billId             String        @map("bill_id")
  bill               ScorecardBill @relation(fields: [billId], references: [id], onDelete: Cascade)
  legislatorId       String        @map("legislator_id")
  legislator         Legislator    @relation(fields: [legislatorId], references: [id], onDelete: Cascade)
  vote               VoteChoice
  alignedWithLiberty Boolean       @map("aligned_with_liberty")
  createdAt          DateTime      @default(now()) @map("created_at")

  @@unique([billId, legislatorId])
  @@index([billId])
  @@map("rlc_scorecard_votes")
}

/// Action Center campaigns for member advocacy
model ActionCampaign {
  id              String              @id @default(uuid())
  title           String
  slug            String              @unique
  description     String?             @db.Text
  billId          String?             @map("bill_id")
  bill            ScorecardBill?      @relation(fields: [billId], references: [id])
  chapterId       String?             @map("chapter_id")
  chapter         Chapter?            @relation(fields: [chapterId], references: [id])
  targetChamber   LegislativeChamber? @map("target_chamber")
  targetStateCode String?             @map("target_state_code")
  messageTemplate String?             @map("message_template") @db.Text
  status          CampaignStatus      @default(draft)
  createdBy       String?             @map("created_by")
  creator         Member?             @relation("CampaignCreator", fields: [createdBy], references: [id])
  startsAt        DateTime?           @map("starts_at")
  endsAt          DateTime?           @map("ends_at")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  participations  CampaignParticipation[]

  @@map("rlc_action_campaigns")
}

/// Tracks member participation in action campaigns
model CampaignParticipation {
  id           String          @id @default(uuid())
  campaignId   String          @map("campaign_id")
  campaign     ActionCampaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  memberId     String          @map("member_id")
  member       Member          @relation(fields: [memberId], references: [id])
  action       String
  legislatorId String?         @map("legislator_id")
  legislator   Legislator?     @relation(fields: [legislatorId], references: [id])
  metadata     Json            @default("{}")
  createdAt    DateTime        @default(now()) @map("created_at")

  @@unique([campaignId, memberId, action, legislatorId])
  @@map("rlc_campaign_participations")
}

// ===========================================
// Dues Sharing & Revenue Split
// ===========================================

/// Stripe Connect Express account for a chapter (1:1)
model ChapterStripeAccount {
  id                    String              @id @default(uuid())
  chapterId             String              @unique @map("chapter_id")
  chapter               Chapter             @relation(fields: [chapterId], references: [id])
  stripeAccountId       String              @unique @map("stripe_account_id")
  status                StripeConnectStatus @default(not_started)
  chargesEnabled        Boolean             @default(false) @map("charges_enabled")
  payoutsEnabled        Boolean             @default(false) @map("payouts_enabled")
  onboardingCompletedAt DateTime?           @map("onboarding_completed_at")
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  @@map("rlc_chapter_stripe_accounts")
}

/// Disbursement preferences for a chapter (1:1)
model ChapterSplitConfig {
  id                 String             @id @default(uuid())
  chapterId          String             @unique @map("chapter_id")
  chapter            Chapter            @relation(fields: [chapterId], references: [id])
  disbursementModel  DisbursementModel  @default(national_managed) @map("disbursement_model")
  isActive           Boolean            @default(true) @map("is_active")
  updatedById        String?            @map("updated_by_id")
  updatedBy          Member?            @relation("SplitConfigUpdater", fields: [updatedById], references: [id])
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  rules              ChapterSplitRule[]

  @@map("rlc_chapter_split_configs")
}

/// Individual percentage allocation to a sub-chapter
model ChapterSplitRule {
  id                  String             @id @default(uuid())
  configId            String             @map("config_id")
  config              ChapterSplitConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  recipientChapterId  String             @map("recipient_chapter_id")
  recipientChapter    Chapter            @relation("SplitRuleRecipient", fields: [recipientChapterId], references: [id])
  percentage          Decimal            @db.Decimal(5, 2)
  sortOrder           Int                @default(0) @map("sort_order")
  isActive            Boolean            @default(true) @map("is_active")
  createdAt           DateTime           @default(now()) @map("created_at")
  updatedAt           DateTime           @updatedAt @map("updated_at")

  @@unique([configId, recipientChapterId])
  @@map("rlc_chapter_split_rules")
}

/// Immutable audit trail: one row per recipient per payment
model SplitLedgerEntry {
  id                     String            @id @default(uuid())
  contributionId         String            @map("contribution_id")
  contribution           Contribution      @relation(fields: [contributionId], references: [id])
  sourceType             SplitSourceType   @map("source_type")
  recipientChapterId     String            @map("recipient_chapter_id")
  recipientChapter       Chapter           @relation("LedgerRecipient", fields: [recipientChapterId], references: [id])
  amount                 Decimal           @db.Decimal(10, 2)
  currency               String            @default("USD")
  status                 SplitLedgerStatus @default(pending)
  stripeTransferId       String?           @map("stripe_transfer_id")
  stripeTransferGroupId  String?           @map("stripe_transfer_group_id")
  transferredAt          DateTime?         @map("transferred_at")
  reversalOfId           String?           @map("reversal_of_id")
  reversalOf             SplitLedgerEntry? @relation("LedgerReversal", fields: [reversalOfId], references: [id])
  reversals              SplitLedgerEntry[] @relation("LedgerReversal")
  splitRuleSnapshot      Json              @default("{}") @map("split_rule_snapshot")
  createdAt              DateTime          @default(now()) @map("created_at")

  @@unique([contributionId, recipientChapterId])
  @@index([recipientChapterId, status, createdAt])
  @@map("rlc_split_ledger_entries")
}
