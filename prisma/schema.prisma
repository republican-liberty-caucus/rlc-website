// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ===========================================
// Enums
// ===========================================

enum MembershipTier {
  student_military
  individual
  premium
  sustaining
  patron
  benefactor
  roundtable
}

enum MembershipStatus {
  new_member  // "new" is reserved in SQL, so we use new_member in Prisma but map to "new" in app logic
  current
  grace
  expired
  pending
  cancelled
  deceased
  expiring
}

enum ContributionType {
  membership
  donation
  event_registration
  merchandise
}

enum PaymentStatus {
  pending
  completed
  failed
  refunded
  cancelled
}

enum ChapterLevel {
  national
  multi_state_region
  state
  intra_state_region
  county
}

enum ChapterStatus {
  active
  inactive
  forming
}

enum HouseholdRole {
  primary
  spouse
  child
}

enum UserRole {
  member
  chapter_officer
  chapter_admin
  state_chair
  regional_coordinator
  national_board
  super_admin
}

// ===========================================
// Core Tables
// ===========================================

/// Organizational hierarchy (self-referential)
model Chapter {
  id               String        @id @default(uuid())
  name             String
  slug             String        @unique
  chapterLevel     ChapterLevel  @map("chapter_level")
  parentChapterId  String?       @map("parent_chapter_id")
  parent           Chapter?      @relation("ChapterHierarchy", fields: [parentChapterId], references: [id])
  children         Chapter[]     @relation("ChapterHierarchy")
  stateCode        String?       @map("state_code") @db.Char(2)
  regionName       String?       @map("region_name")
  status           ChapterStatus @default(active)
  websiteUrl       String?       @map("website_url")
  contactEmail     String?       @map("contact_email")
  leadership       Json          @default("{}")
  metadata         Json          @default("{}")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  // Relations
  members       Member[]
  memberRoles   MemberRole[]
  contributions Contribution[]
  events        Event[]
  posts         Post[]

  @@map("rlc_chapters")
}

/// Members (synced with Clerk users)
model Member {
  id                   String           @id @default(uuid())
  clerkUserId          String?          @unique @map("clerk_user_id")
  email                String           @unique
  firstName            String           @map("first_name")
  lastName             String           @map("last_name")
  phone                String?
  addressLine1         String?          @map("address_line1")
  addressLine2         String?          @map("address_line2")
  city                 String?
  state                String?
  postalCode           String?          @map("postal_code")
  country              String           @default("US")

  // Membership
  membershipTier       MembershipTier   @default(individual) @map("membership_tier")
  membershipStatus     MembershipStatus @default(pending) @map("membership_status")
  membershipStartDate  DateTime?        @map("membership_start_date")
  membershipExpiryDate DateTime?        @map("membership_expiry_date")
  membershipJoinDate   DateTime?        @map("membership_join_date")

  // Chapter affiliation
  primaryChapterId     String?          @map("primary_chapter_id")
  primaryChapter       Chapter?         @relation(fields: [primaryChapterId], references: [id])

  // External IDs
  highlevelContactId   String?          @unique @map("highlevel_contact_id")
  civicrmContactId     Int?             @unique @map("civicrm_contact_id")
  stripeCustomerId     String?          @unique @map("stripe_customer_id")

  // Preferences
  emailOptIn           Boolean          @default(true) @map("email_opt_in")
  smsOptIn             Boolean          @default(false) @map("sms_opt_in")
  doNotPhone           Boolean          @default(false) @map("do_not_phone")

  // Household / family members
  householdId          String?          @map("household_id")
  householdRole        HouseholdRole?   @map("household_role")
  primaryMemberId      String?          @map("primary_member_id")
  primaryMember        Member?          @relation("HouseholdMembers", fields: [primaryMemberId], references: [id])
  householdMembers     Member[]         @relation("HouseholdMembers")

  metadata             Json             @default("{}")
  createdAt            DateTime         @default(now()) @map("created_at")
  updatedAt            DateTime         @updatedAt @map("updated_at")

  // Relations
  roles                MemberRole[]     @relation("MemberRoles")
  grantedRoles         MemberRole[]     @relation("GrantedRoles")
  contributions        Contribution[]
  organizedEvents      Event[]
  eventRegistrations   EventRegistration[]
  posts                Post[]

  @@map("rlc_members")
}

/// Member roles (multi-role support)
model MemberRole {
  id          String    @id @default(uuid())
  memberId    String    @map("member_id")
  member      Member    @relation("MemberRoles", fields: [memberId], references: [id], onDelete: Cascade)
  role        UserRole
  chapterId   String?   @map("chapter_id")
  chapter     Chapter?  @relation(fields: [chapterId], references: [id])
  grantedById String?   @map("granted_by")
  grantedBy   Member?   @relation("GrantedRoles", fields: [grantedById], references: [id])
  grantedAt   DateTime  @default(now()) @map("granted_at")
  expiresAt   DateTime? @map("expires_at")

  @@unique([memberId, role, chapterId])
  @@map("rlc_member_roles")
}

/// Contributions/Donations
model Contribution {
  id                    String           @id @default(uuid())
  memberId              String?          @map("member_id")
  member                Member?          @relation(fields: [memberId], references: [id])
  contributionType      ContributionType @map("contribution_type")
  amount                Decimal          @db.Decimal(10, 2)
  currency              String           @default("USD")

  // Payment details
  stripePaymentIntentId String?          @map("stripe_payment_intent_id")
  stripeSubscriptionId  String?          @map("stripe_subscription_id")
  paymentStatus         PaymentStatus    @default(pending) @map("payment_status")
  paymentMethod         String?          @map("payment_method")

  // Attribution
  chapterId             String?          @map("chapter_id")
  chapter               Chapter?         @relation(fields: [chapterId], references: [id])
  campaignId            String?          @map("campaign_id")

  // For recurring
  isRecurring           Boolean          @default(false) @map("is_recurring")
  recurringInterval     String?          @map("recurring_interval")

  // CiviCRM migration reference
  civicrmContributionId Int?             @unique @map("civicrm_contribution_id")
  transactionId         String?          @map("transaction_id")
  source                String?

  metadata              Json             @default("{}")
  createdAt             DateTime         @default(now()) @map("created_at")

  // Relations
  eventRegistrations    EventRegistration[]

  @@map("rlc_contributions")
}

/// Events
model Event {
  id                   String    @id @default(uuid())
  title                String
  slug                 String    @unique
  description          String?   @db.Text
  eventType            String?   @map("event_type")

  // Timing
  startDate            DateTime  @map("start_date")
  endDate              DateTime? @map("end_date")
  timezone             String    @default("America/New_York")

  // Location
  isVirtual            Boolean   @default(false) @map("is_virtual")
  locationName         String?   @map("location_name")
  address              String?
  city                 String?
  state                String?
  postalCode           String?   @map("postal_code")
  virtualUrl           String?   @map("virtual_url")

  // Registration
  registrationRequired Boolean   @default(true) @map("registration_required")
  maxAttendees         Int?      @map("max_attendees")
  registrationFee      Decimal?  @map("registration_fee") @db.Decimal(10, 2)
  registrationDeadline DateTime? @map("registration_deadline")

  // Ownership
  chapterId            String?   @map("chapter_id")
  chapter              Chapter?  @relation(fields: [chapterId], references: [id])
  organizerId          String?   @map("organizer_id")
  organizer            Member?   @relation(fields: [organizerId], references: [id])

  status               String    @default("draft")
  metadata             Json      @default("{}")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  // Relations
  registrations        EventRegistration[]

  @@map("rlc_events")
}

/// Event Registrations
model EventRegistration {
  id                 String        @id @default(uuid())
  eventId            String        @map("event_id")
  event              Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  memberId           String?       @map("member_id")
  member             Member?       @relation(fields: [memberId], references: [id])

  // For non-member registrations
  guestEmail         String?       @map("guest_email")
  guestName          String?       @map("guest_name")

  registrationStatus String        @default("registered") @map("registration_status")
  checkedInAt        DateTime?     @map("checked_in_at")

  // Payment
  contributionId     String?       @map("contribution_id")
  contribution       Contribution? @relation(fields: [contributionId], references: [id])

  metadata           Json          @default("{}")
  createdAt          DateTime      @default(now()) @map("created_at")

  @@map("rlc_event_registrations")
}

/// Content/Blog Posts
model Post {
  id               String    @id @default(uuid())
  title            String
  slug             String    @unique
  content          String?   @db.Text
  excerpt          String?   @db.Text
  featuredImageUrl String?   @map("featured_image_url")

  authorId         String?   @map("author_id")
  author           Member?   @relation(fields: [authorId], references: [id])
  chapterId        String?   @map("chapter_id")
  chapter          Chapter?  @relation(fields: [chapterId], references: [id])

  status           String    @default("draft")
  publishedAt      DateTime? @map("published_at")

  categories       String[]
  tags             String[]

  seoTitle         String?   @map("seo_title")
  seoDescription   String?   @map("seo_description")

  metadata         Json      @default("{}")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@map("rlc_posts")
}

/// HighLevel Sync Log
model HighLevelSyncLog {
  id              String   @id @default(uuid())
  entityType      String   @map("entity_type")
  entityId        String   @map("entity_id")
  highlevelId     String?  @map("highlevel_id")
  action          String
  status          String   @default("pending")
  errorMessage    String?  @map("error_message") @db.Text
  requestPayload  Json?    @map("request_payload")
  responsePayload Json?    @map("response_payload")
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("rlc_highlevel_sync_log")
}

/// CiviCRM Migration Tracking
model CiviCRMMigrationLog {
  id           String    @id @default(uuid())
  entityType   String    @map("entity_type")
  civicrmId    Int       @map("civicrm_id")
  supabaseId   String?   @map("supabase_id")
  status       String    @default("pending")
  errorMessage String?   @map("error_message") @db.Text
  migratedAt   DateTime? @map("migrated_at")

  @@unique([entityType, civicrmId])
  @@map("rlc_civicrm_migration_log")
}
